{"type":"data","nodes":[{"type":"data","data":[null],"uses":{}},{"type":"data","data":[{"libraryName":1,"itemPath":2,"docItem":3},"sveltejs-sveltekit","advanced-techniques/observability",{"type":4,"path":5,"relevant":6,"token_counts":7,"usage":11,"markdown":15},"page","30-advanced/68-observability.md",true,{"fulltext":8,"digest":9,"short_digest":10},1394,651,224,{"input":12,"output":13,"details":14},2436,1006,null,{"fulltext":16,"digest":17,"short_digest":18,"essence":19},"---\ntitle: Observability\n---\n\n\u003Cblockquote class=\"since note\">\n\t\u003Cp>Available since 2.31\u003C/p>\n\u003C/blockquote>\n\nSometimes, you may need to observe how your application is behaving in order to improve performance or find the root cause of a pesky bug. To help with this, SvelteKit can emit server-side [OpenTelemetry](https://opentelemetry.io) spans for the following:\n\n- The [`handle`](hooks#Server-hooks-handle) hook and `handle` functions running in a [`sequence`](@sveltejs-kit-hooks#sequence) (these will show up as children of each other and the root `handle` hook)\n- Server [`load`](load) functions and universal `load` functions when they're run on the server\n- [Form actions](form-actions)\n- [Remote functions](remote-functions)\n\nJust telling SvelteKit to emit spans won't get you far, though — you need to actually collect them somewhere to be able to view them. SvelteKit provides `src/instrumentation.server.ts` as a place to write your tracing setup and instrumentation code. It's guaranteed to be run prior to your application code being imported, providing your deployment platform supports it and your adapter is aware of it.\n\nBoth of these features are currently experimental, meaning they are likely to contain bugs and are subject to change without notice. You must opt in by adding the `kit.experimental.tracing.server` and `kit.experimental.instrumentation.server` option in your `svelte.config.js`:\n\n```js\n/// file: svelte.config.js\n/** @type {import('@sveltejs/kit').Config} */\nconst config = {\n\tkit: {\n\t\texperimental: {\n\t\t\t+++tracing: {\n\t\t\t\tserver: true\n\t\t\t},\n\t\t\tinstrumentation: {\n\t\t\t\tserver: true\n\t\t\t}+++\n\t\t}\n\t}\n};\n\nexport default config;\n```\n\n> [!NOTE] Tracing — and more significantly, observability instrumentation — can have a nontrivial overhead. Before you go all-in on tracing, consider whether or not you really need it, or if it might be more appropriate to turn it on in development and preview environments only.\n\n## Augmenting the built-in tracing\n\nSvelteKit provides access to the `root` span and the `current` span on the request event. The root span is the one associated with your root `handle` function, and the current span could be associated with `handle`, `load`, a form action, or a remote function, depending on the context. You can annotate these spans with any attributes you wish to record:\n\n```js\n/// file: $lib/authenticate.ts\n\n// @filename: ambient.d.ts\ndeclare module '$lib/auth-core' {\n\texport function getAuthenticatedUser(): Promise\u003C{ id: string }>\n}\n\n// @filename: index.js\n// ---cut---\nimport { getRequestEvent } from '$app/server';\nimport { getAuthenticatedUser } from '$lib/auth-core';\n\nasync function authenticate() {\n\tconst user = await getAuthenticatedUser();\n\tconst event = getRequestEvent();\n\tevent.tracing.root.setAttribute('userId', user.id);\n}\n```\n\n## Development quickstart\n\nTo view your first trace, you'll need to set up a local collector. We'll use [Jaeger](https://www.jaegertracing.io/docs/getting-started/) in this example, as they provide an easy-to-use quickstart command. Once your collector is running locally:\n\n- Turn on the experimental flags mentioned earlier in your `svelte.config.js` file\n- Use your package manager to install the dependencies you'll need:\n  ```sh\n  npm i @opentelemetry/sdk-node @opentelemetry/auto-instrumentations-node @opentelemetry/exporter-trace-otlp-proto import-in-the-middle\n  ```\n- Create `src/instrumentation.server.js` with the following:\n\n```js\n/// file: src/instrumentation.server.js\nimport { NodeSDK } from '@opentelemetry/sdk-node';\nimport { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-proto';\nimport { createAddHookMessageChannel } from 'import-in-the-middle';\nimport { register } from 'node:module';\n\nconst { registerOptions } = createAddHookMessageChannel();\nregister('import-in-the-middle/hook.mjs', import.meta.url, registerOptions);\n\nconst sdk = new NodeSDK({\n\tserviceName: 'test-sveltekit-tracing',\n\ttraceExporter: new OTLPTraceExporter(),\n\tinstrumentations: [getNodeAutoInstrumentations()]\n});\n\nsdk.start();\n```\n\nNow, server-side requests will begin generating traces, which you can view in Jaeger's web console at [localhost:16686](http://localhost:16686).\n\n## `@opentelemetry/api`\n\nSvelteKit uses `@opentelemetry/api` to generate its spans. This is declared as an optional peer dependency so that users not needing traces see no impact on install size or runtime performance. In most cases, if you're configuring your application to collect SvelteKit's spans, you'll end up installing a library like `@opentelemetry/sdk-node` or `@vercel/otel`, which in turn depend on `@opentelemetry/api`, which will satisfy SvelteKit's dependency as well. If you see an error from SvelteKit telling you it can't find `@opentelemetry/api`, it may just be because you haven't set up your trace collection yet. If you _have_ done that and are still seeing the error, you can install `@opentelemetry/api` yourself. \n","## Observability with OpenTelemetry\n\nSvelteKit can emit server-side OpenTelemetry spans for:\n- `handle` hooks and functions in `sequence`\n- Server and universal `load` functions\n- Form actions\n- Remote functions\n\n### Setup\n\nEnable experimental features in `svelte.config.js`:\n```js\nconst config = {\n\tkit: {\n\t\texperimental: {\n\t\t\ttracing: { server: true },\n\t\t\tinstrumentation: { server: true }\n\t\t}\n\t}\n};\n```\n\nCreate `src/instrumentation.server.ts` for tracing setup and instrumentation code. This file runs before application code is imported.\n\n### Augmenting Spans\n\nAccess the root span and current span via `event.tracing`:\n```js\nimport { getRequestEvent } from '$app/server';\n\nconst event = getRequestEvent();\nevent.tracing.root.setAttribute('userId', user.id);\n```\n\nThe root span is associated with the root `handle` function. The current span depends on context (handle, load, form action, or remote function).\n\n### Local Development with Jaeger\n\n1. Install dependencies: `npm i @opentelemetry/sdk-node @opentelemetry/auto-instrumentations-node @opentelemetry/exporter-trace-otlp-proto import-in-the-middle`\n2. Create `src/instrumentation.server.js`:\n```js\nimport { NodeSDK } from '@opentelemetry/sdk-node';\nimport { getNodeAutoInstrumentations } from '@opentelemetry/auto-instrumentations-node';\nimport { OTLPTraceExporter } from '@opentelemetry/exporter-trace-otlp-proto';\nimport { createAddHookMessageChannel } from 'import-in-the-middle';\nimport { register } from 'node:module';\n\nconst { registerOptions } = createAddHookMessageChannel();\nregister('import-in-the-middle/hook.mjs', import.meta.url, registerOptions);\n\nconst sdk = new NodeSDK({\n\tserviceName: 'test-sveltekit-tracing',\n\ttraceExporter: new OTLPTraceExporter(),\n\tinstrumentations: [getNodeAutoInstrumentations()]\n});\n\nsdk.start();\n```\n\n3. View traces at localhost:16686\n\n### Dependencies\n\nSvelteKit uses `@opentelemetry/api` as an optional peer dependency. If you see a missing dependency error, install `@opentelemetry/api` directly or use a library like `@opentelemetry/sdk-node` or `@vercel/otel` which depend on it.\n\n**Note:** Tracing has nontrivial overhead. Consider enabling only in development and preview environments.","## Observability with OpenTelemetry\n\nEnable in `svelte.config.js`:\n```js\nkit: {\n\texperimental: {\n\t\ttracing: { server: true },\n\t\tinstrumentation: { server: true }\n\t}\n}\n```\n\nSvelteKit emits spans for `handle` hooks, `load` functions, form actions, and remote functions. Create `src/instrumentation.server.ts` for tracing setup.\n\nAccess spans via `event.tracing.root` and `event.tracing.current` to add custom attributes.\n\nFor local development with Jaeger, install `@opentelemetry/sdk-node`, `@opentelemetry/auto-instrumentations-node`, `@opentelemetry/exporter-trace-otlp-proto`, and `import-in-the-middle`, then configure the NodeSDK in `src/instrumentation.server.js` to export traces to localhost:16686.","SvelteKit can emit OpenTelemetry spans for server-side operations; enable via config, set up instrumentation in src/instrumentation.server.ts, and augment spans with custom attributes."],"uses":{"params":["name","path"]}}]}
